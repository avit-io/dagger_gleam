name: CI

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

jobs:
  pipeline:
    name: Build, Test and Publish
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      # Bootstrap: fetch schema via Dagger session, then run codegen on host.
      # Produces sdk/src/dagger/dsl/ so that ci.gleam can compile in the next step.
      - name: Bootstrap — Fetch schema and generate DSL
        run: nix develop .#ci --command sh -c 'bash codegen/scripts/fetch_schema.sh && cd codegen && gleam run -m dagger_codegen'

      # On tag pushes, verify that the tag version matches sdk/gleam.toml.
      # Prevents publishing a package whose version is out of sync with the tag.
      - name: Verify tag matches gleam.toml version
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          VERSION=$(grep '^version' sdk/gleam.toml | sed 's/version = "\(.*\)"/\1/')
          TAG=${GITHUB_REF#refs/tags/v}
          if [ "$VERSION" != "$TAG" ]; then
            echo "ERROR: tag v$TAG does not match sdk/gleam.toml version $VERSION"
            exit 1
          fi
          echo "OK: tag v$TAG matches gleam.toml"

      - name: Run CI Pipeline
        env:
          # Publish only on tag pushes — skipped on branch builds and PRs.
          HEXPM_API_KEY: ${{ startsWith(github.ref, 'refs/tags/v') && secrets.HEXPM_API_KEY || '' }}
        run: nix develop .#ci --command sh -c 'cd .ci && gleam deps download && dagger run --progress=plain gleam run'
